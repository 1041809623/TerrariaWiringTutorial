\chapter{液体}\label{app23}

泰拉瑞亚中的每个图格都包含了液体属性，液体属性包含液体量和液体种类。液体量是0到255的一个整数，0表示没有液体，255表示满液体。

泰拉瑞亚中有两个液体数组，一个是活跃液体，大小为5000；一个是缓冲区，大小10000。每当一格液体有潜在的流动可能性，这一格就会被加入液体数组。每帧中液体数组会进行刷新，如果某一格不再有流动的可能性，这一格就会被从液体数组中清除。与射弹数组不同，液体数组始终是从头连续填充的。当液体数组中一格被清除时，空位由液体数组中最后一格液体取代，从而保持连续填充的特性。

活跃液体数量上限与活跃液体数组长度不同，前者是软上限，后者是硬上限。活跃液体上限等于2500+2500$\times$\nameref{app34}。

\section{全图液体刷新}
全图液体刷新有三种模式：恐慌模式、快速模式和正常模式。

\subsection{恐慌模式}
如果活跃液体和缓冲区中总格数连续1800次刷新（30秒）都超过了4000格，或者单次刷新中活跃液体和缓冲区总格数超过了13500格，那么进入恐慌模式。恐慌模式会覆盖快速安置模式和正常模式。

在恐慌模式中，从$\mathtt{maxTilesY}-3$开始，从下到上\hyperref[app30]{快速安置}5行\footnote{实际上当$\mathtt{maxTilesY}<10$时会有出入，但是这种极端情况我们不考虑。}，并把活跃液体和缓冲区全部清空。

\paragraph*{液体快速安置}\label{app30}
该过程有三个参数：\lstinline{verbose}\footnote{暂时不知道\lstinline{verbose}表示什么，但是可以确定的是它不影响本文档中讨论到的内容。}，\lstinline{minY}和{\lstinline{maxY}分别表示刷新区域的上下界。这三个参数都是可选参数，\lstinline{verbose}缺省值为0，\lstinline{maxY}的缺省值为\lstinline{maxTilesY}-3，\lstinline{minY}的缺省值为3。返回值是安置过程中发生变化的液体格数（不包括仅进行了横向安置与纵向安置其一的情况；多次刷新时多次计数）。

快速安置时从下到上逐行刷新。每行刷新三次，第一次和第三次从左到右刷新，第二次从右到左刷新。刷新的两端横坐标分别为2和\lstinline{maxTilesX}-2。每次刷新时刷新起点不刷新终点\footnote{也就是说每行刷新结束时，左端点刷新了2次，右端点刷新了1次，其他点都刷新了3次。}。

进行单格液体安置时，纵向安置与横向安置交替运行。纵向安置时，将液体下移直至遇到障碍。横向安置移动方向优先选择当前的刷新方向，横移直至遇到障碍；如果向当前刷新方向一格都移动不了，则尝试向反向移动。

首先进行纵向安置尝试，尝试结束后，如果本格仍能向下格流动\footnote{下格不满且与本格液体相同。}，那么向下格填充。然后进行横向安置，横向安置时每移动一格后都会插入一个纵向安置尝试与向下格填充尝试，如果成功下移，那么重新进行横向安置。如果某次下格填充尝试后本格液体耗尽，那么安置完成。否则只有当纵向安置和横向安置全部失败时，安置才会完成。

安置完成后，如果上下左右（优先级左>右>上>下，只对其中一格执行）其一与本格可反应且反应物之一是熔岩，那么对熔岩格执行\hyperref[app24]{熔岩反应判定}。

如果本格仍有液体，与上一段类似，执行\hyperref[app25]{蜂蜜反应判定}。

\subsection{快速模式与正常模式}\label{app27}
快速模式的触发条件是活跃液体多于\lstinline{2000}格。快速模式与正常模式都是对活跃液体数组中的一部分从前到后依次进行\hyperref[app26]{刷新}，然后进行后续判定。它们的区别是，快速模式中每个刷新对象的\lstinline{delay}值都会被赋值为\lstinline{10}，这样它们都会快速流动，无论液体黏性如何；而正常模式中黏性会影响流速\footnote{详情见\nameref{app26}。}。另一个区别是，快速模式中不会跳过刷新，而正常模式中可能有一些液体会跳过刷新，关于跳过刷新的机制，请参考\nameref{app26}。

快速模式或正常模式每执行一次，会在\lstinline{wetCounter}中计数。

我们已经提到过，快速模式与正常模式都只是刷新一部分液体。这一部分液体是这么计算出来的：
\begin{itemize}
    \item \lstinline{num1=maxLiquid/cycles}，这个除法是整型除法。
    \item \lstinline{num2=num1*(wetCounter-1)}。
    \item \lstinline{num3=num1*wetCounter}。
    \item 如果\lstinline{num3>maxLiquid}，那么\lstinline{wetCounter=cycles}。
    \item 如果\lstinline{wetCounter=cycles}，那么\lstinline{num3=maxLiquid}。
    \item 刷新活跃液体数组中从\lstinline{num2}到\lstinline{num3-1}这一段。
\end{itemize}

在执行完刷新后，如果\lstinline{wetCounter>=cycles}\footnote{注意\lstinline{wetCounter}不仅会每次递增，还有可能在\lstinline{num3>maxLiquid}时被直接赋值。}，就会在刷新后进行后续判定。\lstinline{cycles}等于\lstinline{17-10*gfxQuality}，向下取整。可能的取值有\lstinline{7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17}。

\paragraph*{后续判定}\label{app29}
将\lstinline{wetCounter}归零。从后往前扫描活跃液体数组，将\lstinline{kill}值大于\lstinline{4}的全部\hyperref[app28]{删除}。将缓冲区的前若干格从前往后依次加入活跃液体数组并从缓冲区中删除，这个数量等于执行该步之前的活跃液体与缓冲区液体数量最大值\footnote{源码如此。}。

然后进行阻塞判定。简单地讲，当活跃液体维持在某个数量附近很长一段时间，那么就进入阻塞模式，将活跃液体强行删除。阻塞判定由阻塞时间与阻塞格数控制。如果有至少一格活跃液体，并且活跃液体格数与阻塞格数相差小于\lstinline{50}格，那么阻塞时间加一；如果阻塞时间达到了10000，那么在阻塞模式中从后往前\hyperref[app28]{删除}所有活跃液体然后将阻塞时间归零。在其他情况下，即活跃液体数组为空或者活跃液体格数与阻塞格数相差至少50格，那么将阻塞格数赋值为活跃液体格数并将阻塞时间归零。

\section{将某格加入活跃液体数组}
如果这一格已经在活跃液体数组中，或者距离地图边缘小于5格，或者没有液体，那么不加入。

如果达到了活跃液体数量上限，将该格加入液体缓冲区。

如果未达到活跃液体数量上限，将该格加入活跃液体数组中第一个空位\footnote{因为液体数组是连续填充的，第一个空位就在最后一个活跃液体之后。}。如果该格中的图格会被对应的液体破坏，那么破坏。

\section{单格活跃液体刷新}\label{app26}
如果本格是可以阻挡液体的图格，\lstinline{kill}值设为9，刷新结束。

如果本格是水并且距离世界底端小于200格，液体量减2。

如果本格液体量为0，\lstinline{kill}值设为9，刷新结束。

如果本格是熔岩，执行熔岩反应判定。如果不是快速安置液体状态，\lstinline{delay}值小于5则加1，达到5则清零，前一种情况下刷新直接结束。也就是说这一步每执行5次才会进行一次刷新。

如果本格不是熔岩，将左右上下四格中是熔岩的图格按顺序加入活跃液体数组。如果本格是蜂蜜，执行蜂蜜反应判定；如果不是快速安置液体状态，\lstinline{delay}值小于10则加1，达到5则清零，前一种情况下刷新直接结束。也就是说这一步每执行10次才会进行一次刷新。如果本格是水，将左右上下四格中是蜂蜜的图格按顺序加入活跃液体数组。

处理纵向流动。如果下格不阻挡液体，与本格液体相同且不满，那么向下流动，把下格加入活跃液体数组，并且本格和下格会跳过下次\hyperref[app27]{正常刷新}。流动后，如果本格液体量大于250，则改为255，否则将左右两格按顺序加入活跃液体数组。

如果本格还有液体，处理横向流动。对左右若干图格，判断是否满足不阻挡液体且和本格液体相同的条件，分为四种情况。
\begin{itemize}
    \item 左右各三格都满足条件。将本格和左右各三格的液体量设为这七格液体量的平均值，四舍五入\footnote{源码中实际的处理方式是四舍六入五留双，但是对于七格平均的情况，该舍入方式等同于四舍五入。}。将左右各三格中液体量变化的图格加入活跃液体数组，顺序是左一、右一、左二、右二、左三、右三。如果本格液体量变化了，将左右各三格全部加入活跃液体数组，顺序同上。如果左右各三格液体量都没有变化并且上格有液体，本格液体量还原到变化之前的值。
    \item 左右各两格都满足条件，但是左三和右三至少有一格不满足条件。对本格和左右各两格进行处理，处理方法和第一条类似。
    \item 左右各两格中左一和右一满足条件，左二或右二不满足条件。将本格和左右各两格中满足条件的图格的液体量设为这几格液体量的平均值，四舍五入。将左右各两格中液体量变化的图格加入活跃液体数组，顺序是左一、右一、左二、右二。
    \item 左一和右一有且仅有一个满足条件。将本格和满足条件的一格的液体量设为这两格液体量的平均值，四舍五入。将左右两格中液体量变化的图格加入活跃液体数组。
\end{itemize}

如果在以上全过程中，本格的液体量从255变成了254，恢复到255。

如果在以上全过程中，本格液体量不变，\lstinline{kill}值增加1，否则\lstinline{kill}值归零。

\section{熔岩反应判定}\label{app24}
对于某格熔岩，如果上下左右四格均无可反应的液体，判定结束。如果上左右三格中至少有一格有可以反应的液体，那么进行第一部分判定；否则进行第二部分判定。

\paragraph*{第一部分判定}
这部分判定解决熔岩与上左右三格反应的情况。首先吸收上左右三格中全部的非熔岩液体。如果吸收液体总量小于24，那么不反应，判定结束。否则该格有三种情况：
\begin{itemize}
    \item 如果该格有可被黑曜石破坏的图格，那么被破坏。
    \item 如果该格有不可被黑曜石破坏的图格，那么判定结束。
    \item 如果该格为空，不执行操作。
\end{itemize}
然后把该格中的液体清空，生成反应块。只要吸收前，上左右三格中有至少一格蜂蜜，就生成松脆蜂蜜块，否则生成黑曜石。

\paragraph*{第二部分判定}
这部分判定解决熔岩与下格反应的情况。首先分为四种情况：
\begin{itemize}
    \item 下格是可以被黑曜石或武器破坏的图格，被破坏。
    \item 下格不是宝箱或梳妆台，本格是宝箱或梳妆台，不执行操作。
    \item 下格不是可以被黑曜石或武器破坏的图格，并且不是宝箱梳妆台那种情况，判定结束。
    \item 下格没有图格，不执行操作。
\end{itemize}
如果本格液体量小于24，直接清零，判定结束。否则进行反应，删除本格和下格的液体，在下格生成反应块。

\paragraph*{蜂蜜反应判定}\label{app25}
蜂蜜反应判定与熔岩反应判定类似。不同的地方是：
\begin{itemize}
    \item 吸收液体量的阈值为32而不是24。
    \item 第一部分判定中，上左右三格有至少一格岩浆，就生成松脆蜂蜜块，否则生成蜂蜜块。
    \item 第二部分判定中，没有宝箱梳妆台那种判定。只要下格不是可以被黑曜石或武器破坏的图格，判定结束。
\end{itemize}

\section{将某格从活跃液体数组中删除}\label{app28}
当游戏推断活跃液体数组中的某格不再流动时，就会把这一格从活跃液体数组中删除。在删除前需要进行一系列结算。

如果本格液体量小于2，那么清零，并且在这种情况下，如果左格或右格液体量小于2，也清零。左格和右格归零时还会被加入活跃液体数组。

如果本格液体量为2到19，并且可以往左右下三格之一流动\footnote{左/右格流是指左/右格液体量小于本格，并且左格允许液体通过。可以往下格流是指下格液体不满，并且允许液体通过。}，那么本格液体清零。

如果本格液体量至少为20，并且可以往下格流动，那么本格的\lstinline{kill}值为0，删除失败，结算结束。在\hyperref[app29]{阻塞模式}中会跳过这一条。

如果本格液体量为20到249，并且上格有液体，那么将上格加入活跃液体数组。

在本格液体还没有被清零的情况下，如果左格有液体并且左下格液体量小于250，将左格加入活跃液体数组；如果右格有液体并且右下格液体量小于250，将右格加入活跃液体数组。如果本格液体是熔岩，执行熔岩反应判定，然后烧掉周围八格的草皮。如果本格液体是蜂蜜，执行蜂蜜反应判定。

以上过程完成以后，就可以把活跃液体数组这个位置删除了。删除的时候，为了保持液体数组连续填充的特性，这一格的位置会由最后一格活跃液体代替。然后如果本格有草药，进行草药破碎检查。

\paragraph*{草药破碎检查}
如果下格不是供草药正常生长的图格，草药破碎。除火焰花之外，如果本格有熔岩，草药破碎。对于火焰花，如果本格有水或蜂蜜，草药破碎。如果火焰花本格有熔岩，那么液体量小于16时，火焰花不开花；否则成熟的火焰花会开花。

需要注意的是，这部分检查并不意味着在游戏中成熟的火焰花不会被熔岩破坏。具体原因还有待研究。