\chapter{农场}

前面我们主要围绕电路理论来讲。这一章中我们会看到一些利用游戏机制的精妙设计。

\section{水晶碎块农场}
\subsection{水晶碎块的生成机制}
在\textbf{困难模式}中，游戏每一帧会将如下的步骤执行多次，执行次数=世界宽度$\times$世界高度$\times$0.000015：
\begin{enumerate}
    \item \textbf{选取支撑块。}在一个超大的矩形区域内随机取一格，如果恰好是粉冰雪块或珍珠石块，并且取的这一格在洞穴或地狱，那么有1/110的概率可以进入下一步，否则不生成水晶。这个矩形区域左右端距离世界左右端各10格，上端为地表，下端距离世界下端20格。
    \item \textbf{选取生成格。}把上一步中取到的一格叫做支撑块。在支撑块下左右三个相邻格中随机取一格，其中取下的概率是1/2，左右的概率各1/4，这一格就作为水晶的生成格。生成格不能被其他图格阻挡，否则不能生成水晶。
    \item \textbf{局部数量限制。}统计以支撑块为中心，13格$\times$13格的正方形区域内已经存在的水晶碎块数量，如果超过了1，那么不能生成水晶。
    \item \textbf{生成水晶。}如果前三步所有检查均通过，那么在生成格生成水晶。
\end{enumerate}

\subsection{三大设计要点}
一个水晶农场主要分三个部分：生长、收割、收集。在生长环节，需要选取使用粉冰雪块还是珍珠石块，还需要设计方块的摆放方式。收割可以通过简单的虚化实现，但是我们需要知道收割的频率。如果使用相对高频的驱动进行收割，那么比较消耗CPU资源；如果使用过于低频的驱动进行收割，那么容易达到局部上限。在收集环节，需要选取使用半砖、传送带还是传送机。半砖速度快，稳定性差；传送带速度慢，稳定性好；传送机速度快，稳定性快，但是不方便操作。所有这三个部分的方案设计都是通过计算实现的。

要生成水晶碎块，需要通过四层检查：选取的方块恰好可以做支撑块；1/110的概率；生成格不能被阻挡；局部数量限制。其中1/110的概率是固定值，先不管。局部数量限制是与基础生成速度相关的，如果水晶碎块生成得快，那么就很容易达到局部数量上限，否则可以忽略掉局部数量上限。

选取方块恰好可以做支撑块的概率，是矩形区域内，洞穴和地狱中粉冰雪块和珍珠石块的比例。我们先假设这个比例是100\%。生成格不能被阻挡，意味着支撑块不能过于密集，不过我们先不管，先假设这个概率也是100\%。这样的话，水晶碎块的最大生成速率是(世界宽度$\times$世界高度$\times$0.000015)个/110帧，这是整个世界中水晶碎块的速率。那么每格上水晶碎块的速率就是0.000015个/110帧\footnote{与worldSurface和rockLayer占世界高度比例相关，这里是非常粗略的估算}。13$\times$13区域的生成速率就是$0.000015\times 13^2$=0.002535个/110帧。达到局部生成上限平均需要2个/(0.002535个/110帧)=86785帧，大约是1天。

回到前两个概率。前两个概率合起来，就是任选一个方块的一个表面，可以生成水晶的概率。换句话说，生成速率与可生成的表面积成正比。\autoref{}所示的排列方式可以达到最大的表面积，在这个排列下，任选一个方块，可以做支撑块的概率是1/2，生成格不被阻挡的概率是100\%，所以水晶碎块的生成速率全部要除以2，达到局部生成上限平均需要约2天。收割周期确定为1天左右，这样不会过于频繁，也不会有太多方块达到上限。

然后考虑收割方式，是一次性虚化收割，还是一块一块收割？掉落物上限是400，一天收割一次的话，要求水晶农场的面积控制在$13\times 13\times 400\textrm{格}=67600$格以内。如果规模更大，就需要一块一块收割。这里每块的大小设置取决于收割后运输的速度。假设总共有$N$块，那么每块的收割间隔是$(86400/N)$帧。假设总面积是$S$格，那么每块的面积是$(S/N)$格，每块收割时掉落约$(S/N/169)$个水晶碎块。达到400个水晶碎块，需要收割$400/(S/N/169)=(67600N/S)$块，也就是说，水晶从掉落到收集，时间是$(86400/N)\times(67600N/S)=(5840640000/S)$帧，超过这个时间就很有可能因为掉落物上限损失水晶。对于大世界来说，$S$至多是$8400\times2400=20160000$格，时间大约是290帧，不到5秒。在5秒内收集全世界的水晶是不可能的。

水晶农场面积越小，对收集速度的要求就越低。当规模较小时，可以使用\autoref{}最大化生成速率；当规模较大时，需要优先考虑便于半砖与传送器运输的结构以增加收集速度。

\section{全自动树场}

\section{生命果/世花农场}

\section{液体反应池}

\section{松露虫农场}

\section{采沙场}

\section{天梯神教}
\subsection{南瓜月天梯神教}
\subsection{霜月天梯神教}

\section{南瓜神教}

\section{全自动月亮事件}

\section{DPS纪录}

\section{速度纪录}

\section{Boss速杀场地}
