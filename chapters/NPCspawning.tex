\chapter{刷怪机制}
执行刷怪的函数为 NPC.SpawnNPC。

如果NPC.noSpawnCycle为true，那么这一帧不刷怪，把NPC.noSpawnCycle重置为false。

如果要刷怪的话，会对每个未死亡的玩家执行刷怪过程。在史莱姆雨进行时，会在其他刷怪之前插入史莱姆雨的刷怪。史莱姆雨的刷怪是额外刷怪，不会影响正常刷怪。

进行正常刷怪时，首先要判断刷怪类型、刷怪率和刷怪量，然后决定是否要刷怪，然后决定刷怪点和刷怪面，最后决定刷什么怪。

\section{史莱姆雨刷怪}

\section{刷怪类型、刷怪率和刷怪量}

\section{刷怪点和刷怪面}

\section{刷怪种类}
刷怪的优先级是四柱>太空>事件>昏迷男子>蜘蛛洞>地下沙漠>巨骨舌鱼>血水母>嗜血怪>海洋>沉睡渔夫>食人鱼>蓝水母>水中小动物>受缚哥布林>受缚巫师>小动物>地牢>陨石>撒旦军团>霜月>南瓜月>日食>发光蘑菇地>腐地蠕虫>宝箱怪>幻灵>弹跳杰克南瓜灯>骷髅博士>紫胶虫>地下蠕虫>老鼠>蜗牛>丛林青蛙>困难模式丛林>神庙。

海洋刷怪中包含部分沉睡渔夫。琵琶鱼包含在食人鱼中。绿水母包含在蓝水母中。

\subsection{四柱}
如果玩家在四柱附近，那么就会刷四柱怪。四柱刷怪的优先级是星云柱>星旋柱>星尘柱>日曜柱。

\subsubsection{星云柱}
刷怪为星云浮怪(ID:420)、吮脑怪(ID:421)、进化兽(ID:423)、预言帝(ID:424)。这四个怪的刷怪比例为1:5:3:3。星云浮怪在整个世界中的上限为2个，进化兽在整个世界中的上限为3个，预言帝在整个世界中的上限为2个。这个刷怪比例\&上限的规则是四柱的特色。举例来说，没有任何刷怪的时候，这四个怪的刷怪概率分别是1/12、5/12、1/4、1/4；如果已经刷出了两个星云浮怪，那么不会再刷星云浮怪，剩下三个怪的刷怪概率分别是5/11、3/11、3/11。

\subsubsection{星旋柱}
刷怪为漩泥怪(ID:425)、异星蜂王(ID:426)、异星黄蜂(ID:427)、星旋怪(ID:429)。刷怪比例为2:1:2:4。漩泥怪上限为3，异星蜂王上限为3，星旋怪上限为4。

\subsubsection{星尘柱}
刷怪为银河织妖(ID:402)、星细胞(ID:405)、流体入侵怪(ID:407)、闪耀炮手(ID:409)、观星怪(ID:411)。刷怪比例为1:1:1:2:3。

\subsubsection{日曜柱}
刷怪为千足蜈蚣(ID:412)、火龙怪(ID:415)、火龙怪骑士(ID:416)、火滚怪(ID:417)、流星火怪(ID:418)、火月怪(ID:419)、火龙战士(ID:518)。刷怪比例为1:1:1:1:1:1:1。千足蜈蚣上限为1，火龙怪上限为2，火龙怪骑士上限为1，火龙战士上限为2。

\subsection{太空刷怪}
优先级是火星飞船>火星探测器>飞龙>鸟妖。

如果执行的是火星入侵的刷怪，那么生成火星飞船(ID:388)。

在石巨人后，通过了Boss与事件检查，玩家中心在\hyperref[app9]{透光墙}或云墙前，刷怪面到世界中心的横坐标距离大于世界宽度$\times$0.165\footnote{小世界为693格，中世界为1056格，大世界为1386格}，那么有概率生成火星探测器(ID:399)，这个概率与是否打过火星入侵、是否在水蜡烛区域、是否有水蜡烛buff相关（\autoref{tab5651}）。水蜡烛区域和水蜡烛buff不是一回事，水蜡烛区域不包括手持水蜡烛的情况。火星探测器的上限为1。

\begin{table}[!h]
    \centering
    \begin{tabular}{cccccc}
         000&001&011&100&101&111\\\hline
         1/8&15/64&5/9&1/30&59/900&19/100 
    \end{tabular}
    \caption{二进制的第一位表示是否打过火星入侵，第二位表示是否在水蜡烛区域，第三位表示是否有水蜡烛buff。例如101表示打过火星入侵，不在水蜡烛区域内，有水蜡烛buff。}
    \label{tab5651}
\end{table}

没有水蜡烛buff的时候，飞龙(ID:87)的生成概率为1/10；有水蜡烛buff的时候生成概率为19/100。飞龙的上限为1。当flag4为false时不会刷飞龙。

如果火星飞船、火星探测器、飞龙均未生成，那么生成鸟妖。

\subsection{事件刷怪}
\subsubsection{哥布林入侵}
1/9概率生成哥布林巫士(ID:29)，8/45概率生成哥布林苦力(ID:26)，32/135概率生成哥布林弓箭手(ID:111)，32/405概率生成哥布林盗贼(ID:27)，64/405概率生成哥布林战士(ID:28)。在困难模式中，有1/30概率生成哥布林召唤师(ID:471)，这会覆盖前面的生成。哥布林召唤师上限为1。

\subsubsection{雪人入侵}
1/7概率生成巴拉雪人(ID:145)，2/7概率生成雪人暴徒(ID:143)；4/7概率生成戳刺先生(ID:144)。

\subsubsection{海盗入侵}
1/11概率生成海盗弩手(ID:215)，10/99概率生成鹦鹉(ID:252)，80/693概率生成海盗神射手(ID:214)，160/693概率生成私船海盗(ID:213)，320/693概率生成海盗水手(ID:212)。

海盗船长(ID:216)有1/30概率生成，会覆盖前面的生成。海盗船长上限为1。

海盗船(ID:491)生成要求入侵进度超过一半，并且刷怪面的左右各20格，上方10格到40格范围内没有实体块。海盗船生成概率是1/20。海盗船上限为1。海盗船的生成会覆盖其他生成。

\subsubsection{火星入侵}
火星飞碟(ID:395)的生成分为两段判定。离入侵结束不到100分\footnote{入侵事件总分为160+40$\times$玩家数量}时，火星飞碟的概率为1/10并且会覆盖其他生成（包括第二段）。第二段中火星飞碟和其他敌怪处理方法相同。

火星飞碟上限为1，火星走妖(ID:520)上限为1。以下是第二段判定。

火星飞碟概率为1/70，鳞甲怪枪手(ID:390)和火星工程师(ID:386)概率均为9/140（火星飞碟达到上限的话，这个概率变为1/14），火星飞船(ID:388)概率为2/35，扰脑怪(ID:381)概率为4/35，激光枪手(ID:382)概率为4/35，火星走妖(ID:520)概率为1/7，灰咕噜兽(ID:385)、电击怪(ID:389)和火星军官(ID:383)概率均为1/7（火星走妖达到上限的话，这个概率为4/21）。

\subsection{昏迷男子}
满足昏迷男子生成条件，并且不是水中刷怪，那么有1/80概率生成昏迷男子。

\subsection{蜘蛛洞}
刷怪面有蜘蛛墙，不高于 rockLayer，距离世界底端大于210格，且不是水中刷怪，未解救过发型师，那么有1/8概率生成受缚发型师(ID:354)。

在未生成受缚发型师的前提下，如果刷怪面有蜘蛛墙或者判定为蜘蛛洞刷怪，那么困难模式生成黑隐士(ID:163)，困难模式前生成爬墙蜘蛛(ID:164)。

\subsection{地下沙漠}
进行地下沙漠刷怪的要求是刷怪面在地下，并且刷怪面上的背景墙是硬化沙墙/沙岩墙，或者它们的转化墙\footnote{神圣化、腐化、血腥化}。刷怪优先级是沙虫>墓穴爬虫>困难模式>其他。

沙虫(ID:510)和墓穴爬虫(ID:513)的生成都要求flag4为false，并且刷怪面在地表下100格以下。沙虫的概率为1/33，墓穴爬虫的概率为1/22。沙虫只会在困难模式生成。

在困难模式中，有4/5的概率进行困难模式刷怪。困难模式的刷怪有腐恶食尸鬼(ID:525)、红染食尸鬼(ID:526)、神梦食尸鬼(ID:527)、食尸鬼(ID:524)、沙漠幽魂(ID:533)、邪恶拉弥亚(ID:529)、沙贼(ID:530)、拉弥亚(ID:528)、蛇蜥怪(ID:532)，它们的刷怪比例为2:2:2:2:1:1:1:1:1，腐恶食尸鬼在腐化环境生成，红染食尸鬼在血腥环境生成，神梦食尸鬼在神圣环境生成，食尸鬼只在纯净环境生成，沙漠幽魂和邪恶拉弥亚在腐化或血腥环境生成，沙贼和拉弥亚在没有腐化和血腥的环境生成，蛇蜥怪不挑环境。举例来说，如果玩家同时处在血腥和神圣环境中，那么可以生成红染食尸鬼、神梦食尸鬼、沙漠幽魂、邪恶拉弥亚、蛇蜥怪，其刷怪比例为2:2:1:1:1。

既没刷出沙虫或墓穴爬虫，也没有困难模式刷怪，那么刷蚁狮（ID:69)/蚁狮马(ID:508)/蚁狮蜂(ID:509)，刷怪比例为1:3:1。

\subsection{巨骨舌鱼}
困难模式+水中刷怪+丛林环境，2/3概率生成巨骨舌鱼(ID:157)。

\subsection{血水母}
困难模式+水中刷怪+血腥环境，2/3概率生成血水母(ID:242)。

\subsection{嗜血怪}
困难模式+水中刷怪+血腥环境，2/3概率生成嗜血怪(ID:241)。

\subsection{海洋}
要求：水中刷怪，刷怪横坐标距离地图左右边界<250格，刷怪面是沙块或珍珠/黑檀/猩红沙块，刷怪面纵坐标在rockLayer之上。优先级：沉睡渔夫>其他。

\subsubsection{沉睡渔夫}
要求：刷怪横坐标在安全区域外，满足沉睡渔夫生成条件。

从刷怪面向上搜索47格（不包括刷怪面）找到第一个可以生成沉睡渔夫的图格，这一格需要满足：没有实体块；上方第一格没有实体块；上方第二格没有液体；上方第二格没有实体块。如果找到了这一格，那么生成沉睡渔夫(ID:376)。

\subsubsection{其他}
1/60概率生成海蜗牛(ID:220)，59/1500概率生成乌贼(ID:221)，59/500概率生成鲨鱼(ID:65)，413/1500概率生成螃蟹(ID:67)，413/750概率生成粉水母(ID:64)。

\subsection{沉睡渔夫}
要求：不是水中刷怪，刷怪横坐标距离地图左右边界<340格，刷怪面是沙块或珍珠/黑檀/猩红沙块刷怪面纵坐标在worldSurface之上，满足沉睡渔夫生成条件。生成沉睡渔夫。

\subsection{食人鱼}
要求：水中刷怪。刷怪面在rockLayer之下，有1/2概率生成食人鱼(ID:58)；刷怪面是丛林草皮，必然生成食人鱼。在困难模式，生成的食人鱼有2/3概率转化为琵琶鱼(ID:102)。

\subsection{蓝水母}
要求：水中刷怪，刷怪面在worldSurface之下。有1/3概率生成蓝水母(ID:63)。困难模式中生成的蓝水母转化为绿水母(ID:103)。

\subsection{水中小动物}
如果是水中刷怪，在腐化环境有1/4概率生成腐化金鱼(ID:57)。

如果是水中刷怪，不在腐化环境，刷怪面在worldSurface之上，刷怪面距离世界顶端大于50格，在白天，有1/6概率在水面\footnote{这里的水面判定与海洋沉睡渔夫的判定相同。}等概率生成鸭(ID:364)或野鸭(ID:362)。上一句话中没有成功生成的话，生成金鱼(ID:55)。

如果未判定生成小动物，那么生成友好水中小动物的概率额外乘1/4。

\subsection{受缚哥布林}
要求：满足受缚哥布林生成条件，不是水中刷怪，刷怪面不在rockLayer之上，刷怪面距离世界底端大于210格。有1/20概率生成受缚哥布林(ID:105)。

\subsection{受缚巫师}
要求：满足受缚巫师生成条件，，不是水中刷怪，刷怪面不在rockLayer之上，刷怪面距离世界底端大于210格。有1/20概率生成受缚巫师(ID:106)。

\subsection{小动物}
要求：判定生成小动物，不是水中刷怪。丛林草皮上有1/150概率生成金蛙(ID:445)，149/150概率生成青蛙(ID:361)。雪块和冰雪块上企鹅(ID:149)和蓝企鹅(ID:148)生成概率各半。在草皮或神圣草皮上的刷怪优先级：雨天>萤火虫>鸟(1)>蝴蝶>鸟(2)>兔兔和松鼠。其他情况下，如果刷怪面不在worldSurface之下，生成失败；否则生成规则与草皮上的生成规则相同，除了在刷怪面是沙块时，兔兔和松鼠会被各1/2概率生成的黑蝎子(ID:366)和蝎子(ID:367)替代。

\subsubsection{雨天}
在雨天，2/3概率生成蠕虫(ID:357)，1/3概率生成步行金鱼(ID:230)。此外，有1/150的概率它们会被金蠕虫(ID:448)覆盖。

\subsubsection{萤火虫}\label{app14}
要求：在晚上，刷怪面不在worldSurface之下。如果刷怪面是草皮，生成萤火虫(ID:355)；否则生成荧光虫(ID:358)。有1/fireFlyFriendly的概率生成。在成功生成的前提下，在刷怪面的上下左右共4格分别有1/fireFlyMultiple的概率额外生成一个。

有1/9的概率，fireFlyFriendly在1到3随机，fireFlyMultiple在3到7随机；有8/27的概率，fireFlyFriendly和fireFlyMultiple均为999999；有16/27的概率，fireFlyFriendly在2到14随机，fireFlyMultiple在6到29随机。它们的值在每天入夜时刷新。

\subsubsection{鸟(1)}\label{app13}
要求：在4:30到9:30，刷怪面不在worldSurface之下。有2/3概率生成某种鸟。

在确定生成某种鸟的前提下，有1/4概率生成红雀(ID:297)，1/4概率生成冠蓝鸦(ID:298)，1/2概率生成鸟(ID:74).此外，有1/150的概率它们会被金鸟(ID:442)覆盖。

\subsubsection{蝴蝶}\label{app11}
要求：白天，刷怪面不在worldSurface之下。生成某种蝴蝶的概率是1/butterflyChance。butterflyChance的值在每天入夜时刷新，有1/3概率为999999，剩下2/3概率在1到24随机。

在确定生成某种蝴蝶的前提下，有1/150概率生成金蝴蝶(ID:444)，149/150概率生成蝴蝶(ID:356)。此外，在刷怪面的左右共2格分别有1/4的概率额外生成一个蝴蝶。

\subsubsection{鸟(2)}
要求：刷怪面不在worldSurface之下。有1/2概率生成某种鸟。其他刷怪概率与鸟(1)相同。

\subsubsection{兔兔和松鼠}\label{app12}
各种松鼠要求刷怪面不在worldSurface之下。刷怪优先级：金兔>金松鼠>史莱姆兔兔>圣诞节兔兔>派对兔兔>松鼠=红松鼠>兔兔。金兔(ID:443)概率1/150，金松鼠(ID:539)概率1/150，史莱姆兔兔(ID:303)概率2/3（要求万圣节期间），圣诞节兔兔(ID:337)概率2/3（要求圣诞节期间），派对兔兔(ID:540)概率2/3（要求派对期间），松鼠(ID:299)和红松鼠(ID:538)概率各1/6，以上所有均未成功生成的，生成兔兔(ID:46)。

\subsection{地牢}
要求：在地牢环境。刷怪优先级：地牢守卫>受缚机械师>骷髅李小龙>骷髅突击手=骷髅狙击手=骷髅特警>圣骑士=巨型诅咒骷髅头>褴褛邪教徒法师=死灵法师=魔教徒>生锈装甲骷髅=蓝装甲骷髅=地狱装甲骷髅>地牢史莱姆>尖刺球=烈焰火轮=诅咒骷髅头>暗黑法师>愤怒骷髅怪。部分敌怪只会在击败世纪之花后的困难模式出现，而且部分敌怪的生成依赖于刷怪面的背景墙种类，这两个信息下文会省略(\href{https://terraria-zh.gamepedia.com/地牢\#.E5.9B.B0.E9.9A.BE.E6.A8.A1.E5.BC.8F.E4.B8.96.E7.BA.AA.E4.B9.8B.E8.8A.B1.E5.90.8E.E7.9A.84.E5.9C.B0.E7.89.A2}{Wiki})。

如果没打过骷髅王，生成地牢守卫(ID:68)。未解救机械师，刷怪面在rockLayer之下，有1/5概率生成受缚机械师(ID:123)。骷髅李小龙(ID:287)概率1/30。骷髅突击手(ID:293)、骷髅狙击手(ID:291)、骷髅特警(ID:292)概率都是1/15。圣骑士(ID:290)概率1/35，世界中只能存在一个。巨型诅咒骷髅头(ID:289)概率1/30。褴褛邪教徒法师(ID:281/282)、死灵法师(ID:283/284)、魔教徒(ID:285/286)概率都是1/20；它们各有两个ID，生成概率均等；世界中分别只能存在一个。生锈装甲骷髅(ID:269/270/271/272)、蓝装甲骷髅(ID:273/274/275/276)、地狱装甲骷髅(ID:277/278/279/280)概率都是2/3；它们各有4个ID，生成概率均等。地牢史莱姆(ID:71)概率1/37。尖刺球(ID:70)概率1/4；要求以刷怪面为中心的边长600像素的正方形与最近的另一个尖刺球的支撑块不相交。烈焰火轮(ID:72)概率1/15。诅咒骷髅头(ID:34)概率1/9。暗黑法师(ID:32)概率1/7。

以上均未生成时，生成愤怒骷髅怪。愤怒骷髅怪一共有6个ID：294、295、296、31、-14、-13(\href{https://terraria-zh.gamepedia.com/愤怒骷髅怪}{Wiki})，它们的概率分别是1/5、1/5、1/5、6/25、1/10、3/50。

\subsection{陨石}
在陨石环境，生成流行头(ID:23)。

\subsection{撒旦军团}
撒旦军团事件在进行时，并且玩家在事件区域内，那么不刷怪。

\subsection{霜月}
要求：刷怪面不高于worldSurface，在晚上，在霜月中。刷怪优先级：礼物宝箱怪>其他。

与波数无关的是礼物宝箱怪(ID:341)。只要世界中只存在不到4个礼物宝箱怪，它就会以1/30的概率生成。

第20波，冰雪女王(ID:345)、圣诞坦克(ID:346)、常绿尖叫怪(ID:344)概率各1/3。

第19波，刷怪优先级：冰雪女王>圣诞坦克>常绿尖叫怪>雪兽。冰雪女王概率1/10，上限4个。圣诞坦克概率1/10，上限5个。常绿尖叫怪概率1/10，上限7个。这三个怪都不生成的情况下生成雪兽(ID:343)。

第18波，刷怪优先级：冰雪女王>圣诞坦克>常绿尖叫怪>其他。冰雪女王概率1/10，上限3个。圣诞坦克概率1/10，上限4个。常绿尖叫怪概率1/10，上限6个。这三个怪都不生成的情况下，胡桃夹士(ID:348)概率1/3，坎卜斯(ID:351)概率2/9，雪兽概率4/9。

第17波，刷怪优先级：冰雪女王>圣诞坦克>常绿尖叫怪>其他。冰雪女王概率1/10，上限2个。圣诞坦克概率1/10，上限3个。常绿尖叫怪概率1/10，上限5个。这三个怪都不生成的情况下，精灵直升机(ID:347)概率1/4，坎卜斯概率3/8，雪兽概率3/8。

第16波，刷怪优先级：冰雪女王>圣诞坦克>常绿尖叫怪>其他。冰雪女王概率1/10，上限2个。圣诞坦克概率1/10，上限2个。常绿尖叫怪概率1/10，上限4个。这三个怪都不生成的情况下，雪花怪(ID:352)概率1/2，雪兽概率1/2。

第15波，刷怪优先级：冰雪女王>圣诞坦克>常绿尖叫怪>其他。冰雪女王概率1/10，上限1个。圣诞坦克概率1/10，上限2个。常绿尖叫怪概率1/10，上限3个。这三个怪都不生成的情况下，精灵直升机概率1/3，雪兽概率2/3。

第14波，刷怪优先级：冰雪女王>圣诞坦克>常绿尖叫怪>其他。冰雪女王概率1/10，上限1个。圣诞坦克概率1/10，上限1个。常绿尖叫怪概率1/10，上限1个。这三个怪都不生成的情况下，雪兽概率1/3，不刷怪概率2/3。

第13波，刷怪优先级：冰雪女王>圣诞坦克>其他。冰雪女王概率1/10，上限1个。圣诞坦克概率1/10，上限1个。这两个怪都不生成的情况下，雪花怪概率1/3，雪兽概率1/9，姜饼人(ID:342)概率5/27，精灵直升机概率10/27。

第12波，刷怪优先级：冰雪女王>常绿尖叫怪>其他。冰雪女王概率1/10，上限1个。常绿尖叫怪概率1/10，上限1个。这两个怪都不生成的情况下，雪兽概率1/8，姜饼人概率7/24，僵尸精灵(ID:338/339/340)概率7/12。僵尸精灵的三个ID等概率生成。

第11波，刷怪优先级：冰雪女王>其他。冰雪女王概率1/10，上限1个。冰雪女王不生成的情况下，雪花怪概率1/6，姜饼人概率5/12，僵尸精灵概率5/12。

第10波，刷怪优先级：圣诞坦克>常绿尖叫怪>其他。圣诞坦克概率1/10，上限1个。常绿尖叫怪概率1/10，上限2个。这两个怪都不生成的情况下，坎卜斯概率1/6，胡桃夹士概率5/18，精灵直升机概率5/27，僵尸精灵概率10/27。

第9波，刷怪优先级：圣诞坦克>常绿尖叫怪>其他。圣诞坦克概率1/10，上限1个。常绿尖叫怪概率1/10，上限1个。这两个怪都不生成的情况下，胡桃夹士概率1/2，精灵直升机概率1/6，姜饼人概率1/3。

第8波，刷怪优先级：圣诞坦克>其他。圣诞坦克概率1/10，上限1个。圣诞坦克不生成的情况下，坎卜斯概率1/8，胡桃夹士概率7/24，精灵直升机概率7/36，精灵弓箭手(ID:350)概率7/18。

第7波，刷怪优先级：圣诞坦克>其他。圣诞坦克概率1/10，上限1个。圣诞坦克不生成的情况下，姜饼人概率1/3，精灵弓箭手概率1/6，僵尸精灵概率1/2。

第6波，刷怪优先级：常绿尖叫怪>其他。常绿尖叫怪概率1/10，上限2个。常绿尖叫怪不生成的情况下，精灵直升机概率1/4，胡桃夹士概率3/8，精灵弓箭手概率3/8。

第5波，刷怪优先级：常绿尖叫怪>其他。常绿尖叫怪概率1/10，上限1个。常绿尖叫怪不生成的情况下，精灵弓箭手概率1/4，胡桃夹士概率3/32，僵尸精灵概率21/32。

第4波，刷怪优先级：常绿尖叫怪>其他。常绿尖叫怪概率1/10，上限1个。常绿尖叫怪不生成的情况下，精灵弓箭手概率1/4，姜饼人概率1/4，僵尸精灵概率1/2。

第3波，胡桃夹士概率1/8，精灵弓箭手概率7/32，姜饼人概率7/32，僵尸精灵概率7/16。

第2波，僵尸弓箭手概率1/3，僵尸精灵概率2/3。

第1波，姜饼人概率1/3，僵尸精灵概率2/3。

\subsection{南瓜月}
要求：刷怪面不高于worldSurface，在晚上，在南瓜月中。

第1波，生成稻草人(ID:305/306/307/308/309/310/311/312/313/314)，10个ID等概率生成。

第2波，树精(ID:326)概率1/3，稻草人概率2/3。

第3波，地狱犬(ID:329)概率1/6，树精概率5/18，稻草人概率5/9。

第4波，刷怪优先级：哀木>其他。哀木(ID:325)概率1/10，上限1个。哀木不生成的情况下，地狱犬概率1/10，树精概率9/20，稻草人概率9/20。

第5波，刷怪优先级：哀木>其他。哀木概率1/10，上限1个。哀木不生成的情况下，胡闹鬼(ID:330)概率1/8，地狱犬概率7/40，树精概率7/20，稻草人概率7/20。

第6波，刷怪优先级：哀木>其他。哀木概率1/7，上限2个。哀木不生成的情况下，胡闹鬼概率1/6，地狱犬概率5/18，树精概率5/9。

第7波，刷怪优先级：南瓜王>其他。南瓜王概率1/10，上限1个。南瓜王不生成的情况下，胡闹鬼概率1/8，地狱犬概率7/40，稻草人概率7/10。

第8波，刷怪优先级：南瓜王>其他。南瓜王概率1/10，上限1个。南瓜王不生成的情况下，胡闹鬼概率1/5，地狱犬概率4/15，树精概率8/15。

第9波，刷怪优先级：南瓜王>哀木>无头骑士>其他。南瓜王概率1/8，上限1个。哀木概率1/8，上限1个。无头骑士(ID:315)概率1/10，上限1个。这三个怪都不生成的情况下生成稻草人。

第10波，刷怪优先级：南瓜王>哀木>无头骑士>其他。南瓜王概率1/10，上限1个。哀木概率1/10，上限1个。无头骑士概率1/10，上限1个。这三个怪都不生成的情况下，胡闹鬼概率1/8，地狱犬概率7/40，树精概率7/10。

第11波，刷怪优先级：哀木>无头骑士>其他。哀木概率1/7，上限2个。无头骑士概率1/10，上限1个。这两个怪都不生成的情况下，胡闹鬼概率1/10，地狱犬概率9/70，树精概率9/35，稻草人概率18/35。如果世界中没有南瓜王，还有1/10概率额外生成一个南瓜王。

第12波，刷怪优先级：哀木>无头骑士>其他。哀木概率1/7，上限2个。无头骑士概率1/7，上限2个。这两个怪都不生成的情况下，胡闹鬼概率1/7，地狱犬概率6/35，树精概率24/35。如果世界中南瓜王数量小于2，还有1/7概率额外生成一个南瓜王。

第13波，刷怪优先级：哀木>无头骑士>其他。哀木概率1/5，上限3个。无头骑士概率1/5，上限3个。这两个怪都不生成的情况下，胡闹鬼概率1/3，地狱犬概率2/3。如果世界中南瓜王数量小于2，还有1/7概率额外生成一个南瓜王。

第14波，刷怪优先级：南瓜王>哀木>其他。南瓜王概率1/5，上限3个。哀木概率1/5，上限3个。这两个怪都不生成的情况下生成无头骑士。

第15波，南瓜王和哀木概率各为1/2。

\subsection{日食}
要求：刷怪面不在worldSurface之下，在白天，在日食中。刷怪优先级：蛾怪>眼怪>变态人>钉头>致命球>吸血鬼>死神>攀爬魔>飞人博士>屠夫>科学怪人=水月怪=弗里茨=沼泽怪。

蛾怪(ID:477)概率1/80，要求击败三个机械Boss，上限1个。眼怪(ID:251)概率1/50，上限1个。变态人(ID:466)概率1/5，要求击败世纪之花，上限1个。钉头(ID:463)概率1/20，要求击败世纪之花，上限1个。致命球(ID:467)概率1/20，要求击败世纪之花，上限2个。吸血鬼(ID:159)概率1/15。死神(ID:253)概率1/13，要求击败三个机械Boss。攀爬魔(ID:469)概率1/8。飞人博士(ID:468)概率1/7，要求击败世纪之花。屠夫(ID:460)概率1/5，要求击败世纪之花。科学怪人(ID:162)、水月怪(ID:461)、弗里茨(ID:462)、沼泽怪(ID:166)概率各1/4。

\subsection{发光蘑菇地}
要求：刷怪面为蘑菇草皮。刷怪优先级：水中刷怪>地表刷怪>地下刷怪。地表刷怪和地下刷怪由刷怪面位置决定，它们的交界为worldSurface。需要注意的是，刷怪面在worldSurface上时，地表刷怪和地下刷怪都会有效，此时应用优先级关系。

水中刷怪，困难模式会刷蘑菇鱼(ID:256)。

地表刷怪，有2/3概率成功刷怪。在这部分概率里，刷怪优先级为发光蜗牛>蘑菇僵尸=孢子僵尸=歪尾真菌=瓢虫>巨型真菌球怪>真菌球怪。发光蜗牛(ID:360)在困难模式概率1/12，困难模式之前概率37/72。蘑菇僵尸(ID:255)和孢子僵尸(ID:254)概率各1/3，歪尾真菌(ID:257)和瓢虫(ID:258)概率各1/8。巨型真菌球怪(ID:260)概率2/3，要求困难模式。以上所有敌怪均未生成，则生成真菌球怪(ID:259)。

地下刷怪要求困难模式，有2/3概率成功刷怪。在这部分概率里，刷怪优先级为松露虫>发光蜗牛>歪尾真菌=瓢虫>巨型真菌球怪>真菌球怪。松露虫(ID:374)概率为1/5，要求困难模式。发光蜗牛在困难模式概率1/8，困难模式之前概率11/32。歪尾真菌和瓢虫概率各1/8。巨型真菌球怪(ID:260)概率2/3，要求困难模式。以上所有敌怪均未生成，则生成真菌球怪(ID:259)。

\subsection{腐地蠕虫}
要求：腐化环境，flag4为false。进行腐地蠕虫刷怪的概率是1/65。困难模式之前生成吞噬怪(ID:7)。困难模式中吞噬怪概率1/4，吞世怪(ID:98)概率3/4。

\subsection{宝箱怪}
第一轮判定要求：困难模式，刷怪面在worldSurface之下。刷宝箱怪的概率是1/75。

刷怪优先级：腐化宝箱怪>猩红宝箱怪>神圣宝箱怪>普通宝箱怪。腐化宝箱(ID:473)怪概率1/2，要求腐化环境，上限为1个。猩红宝箱怪(ID:474)概率1/2，要求血腥环境，上限为1个。神圣宝箱怪(ID:475)概率1/2，要求神圣环境，上限为1个。这三个环境宝箱怪都不生成，则生成普通宝箱怪(ID:85)。

在第一轮判定失败的情况下，进行第二轮判定。第二轮判定要求：困难模式，刷怪面上方一格是天然土墙。有1/20概率刷普通宝箱怪。

\begin{remark}
如果环境为腐化、猩红、神圣的混合环境，并且符合第一轮判定条件，不符合第二轮判定条件，那么生成的第一个宝箱怪，有1/2概率是腐化宝箱怪，1/4概率是猩红宝箱怪，1/8概率是神圣宝箱怪，1/8概率是普通宝箱怪。
\end{remark}

\subsection{幻灵(ID:82)}
要求：困难模式，刷怪面不低于worldSurface，在晚上。新月期间概率6/25，其他时间为1/20。

\subsection{弹跳杰克南瓜灯(ID:304)}
要求：困难模式，万圣节期间，刷怪面不低于worldSurface，在晚上。概率1/10。

\subsection{骷髅博士(ID:52)}
要求：刷怪面为丛林草皮，在晚上。概率1/500。

\subsection{紫胶虫(ID:219)}
要求：刷怪面为丛林草皮，刷怪面低于worldSurface。概率1/60。

\subsection{地下蠕虫}
要求：刷怪面低于worldSurface，刷怪面距离世界底端大于210格，不在苔原环境，不在血腥环境，不在腐化环境，不在丛林环境，不在神圣环境。概率1/8。生成的蠕虫有1/150概率被替换为金蠕虫。

\subsection{老鼠}
要求：刷怪面低于worldSurface，刷怪面距离世界底端大于210格，不在苔原环境，不在血腥环境，不在腐化环境，不在丛林环境，不在神圣环境。概率1/13。生成的老鼠(ID:300)有1/150概率被替换为金老鼠(ID:447)。

\subsection{蜗牛(ID:359)}
要求：刷怪面低于worldSurface，刷怪面高于rockLayer与世界底端的中点，不在苔原环境，不在血腥环境，不在腐化环境，不在神圣环境。概率1/13。

\subsection{丛林青蛙}
要求：刷怪面高于worldSurface，丛林环境。青蛙概率1/9。生成的青蛙有1/150概率被替换为金蛙。

\subsection{困难模式丛林}
要求：刷怪面为丛林草皮，困难模式。进行困难模式丛林刷怪的概率为2/3。刷怪优先级：地表丛林=地下丛林>其他

\subsubsection{地表丛林}
要求：刷怪面高于worldSurface。在晚上有1/3概率生成巨型飞狐(ID:152)，在白天有3/4概率生成跳跳兽(ID:177)。

\subsubsection{地下丛林}
要求：刷怪面低于worldSurface。蛾(ID:205)概率1/100，丛林蜘蛛(ID:236)概率99/500，青苔黄蜂(ID:176/-18/-19/-20/-21)概率297/1000。青苔黄蜂的5个ID生成比例为6561:729:810:900:1000。

\subsubsection{其他}
愤怒捕手(ID:175)概率1/3，巨型陆龟(ID:153)概率2/3。

\begin{remark}
如果刷怪面恰好在worldSurface上，那么地表丛林和地下丛林都会跳过，只会生成愤怒捕手和巨型陆龟。
\end{remark}

\subsection{丛林}
丛林的三种刷怪环境是互斥的，所以不存在优先级问题。神庙和地下丛林一定会刷怪，地表丛林不一定。

\subsubsection{神庙}
要求：玩家中心在天然丛林蜥蜴砖墙前，刷怪面是丛林蜥蜴砖。丛林蜥蜴(ID:198)概率2/3，飞蛇(ID:226)概率1/3。

\subsubsection{地下丛林}
要求：刷怪面是丛林草皮，刷怪面在worldSurface和rockLayer的中点之下。

尖刺丛林史莱姆(ID:204)概率1/4，食人怪(ID:43)概率3/16，黄蜂(ID:42/231/232/233/234/235/-16/-17/-56/-57/-58/-59/-60/-61/-62/-63/-64/-65)概率9/16。这所有ID对应的黄蜂变种见\autoref{tab8381}。六种主黄蜂变种的刷怪比例为3:1:1:1:1:1，原变种、小变种和大变种的刷怪比例为9:3:4。\href{https://terraria-zh.gamepedia.com/黄蜂}{黄蜂Wiki}

\begin{table}[!h]
    \centering
    \begin{tabular}{c|cccccc}
         &黄蜂&肥胖黄蜂&蜂蜜黄蜂&多叶黄蜂&尖刺黄蜂&毒刺黄蜂\\\hline
         原变种&42&231&232&233&234&235\\
         小变种&-16&-56&-58&-60&-62&-64\\
         大变种&-17&-57&-59&-61&-63&-65
    \end{tabular}
    \caption{所有黄蜂变种的ID}
    \label{tab8381}
\end{table}

\subsubsection{地表丛林}
要求：刷怪面是丛林草皮，刷怪面不在worldSurface和rockLayer的中点之下。丛林蝙蝠(ID:51)概率1/4，抓人草(ID:56)概率3/32。

\subsection{沙尘暴}
要求：正在进行沙尘暴，在沙尘暴区域中，刷怪面是沙块/黑檀沙块/猩红沙块/珍珠沙块，刷怪面通过了沙块的局部聚簇检查。

未击杀过克苏鲁之眼，困难模式前。愤怒翻滚怪(ID:546)概率1/2，蚁狮马概率1/4，蚁狮(ID:69)概率1/8，秃鹰(ID:61)概率1/8。

其他情况。沙尘精(ID:541)概率1/20，上限1个，要求困难模式。沙虫(ID:510)概率1/3，上限4个，要求困难模式，flag4为false。沙鲨概率1/2，要求困难模式，flag4为false；根据刷怪面的不同，沙块上生成沙鲨(ID:542)，黑檀沙块上生成噬骨沙鲨(ID:543)，猩红沙块上生成戮血沙鲨(ID:544)，珍珠沙块上生成晶狐沙鲨(ID:545)。木乃伊概率1/3，要求困难模式；根据刷怪面的不同，沙块上生成木乃伊(ID:78)，黑檀沙块或猩红沙块上生成暗黑木乃伊(ID:79)，珍珠沙块上生成光明木乃伊(ID:80)。以上均未成功生成，愤怒翻滚怪概率1/2，蚁狮马概率1/4，蚁狮蜂概率1/4。

\subsection{木乃伊}
要求：困难模式及某些特定刷怪面。沙块上普通木乃伊概率为1/3。黑檀沙块或猩红沙块上暗黑木乃伊概率为1/2。珍珠沙块上光明木乃伊概率1/2。

\subsection{地表神圣}
要求：困难模式，不是水中刷怪，刷怪面是珍珠沙块、珍珠石块、神圣草皮、粉冰雪块，刷怪面在rockLayer之上。刷怪优先级：腹足怪>妖精=独角兽。腹足怪(ID:122)概率1/2，要求在晚上。腹足怪没有生成的前提下，水蜡烛区域内妖精(ID:75)概率81/100，独角兽(ID:86)概率19/100；水蜡烛区域外妖精概率9/10，独角兽概率1/10。

\subsection{附魔剑(ID:84)}
要求：困难模式，不是水中刷怪，flag4为false，刷怪面是珍珠沙块、珍珠石块、神圣草皮、粉冰雪块，刷怪面不在rockLayer之上。概率1/50。

\subsection{猩红之地}
要求：刷怪面是猩红石块、猩红沙块、红冰雪块、猩红草皮。如果玩家在猩红之地，那么猩红矿也可以做刷怪面。刷怪优先级：恶心浮游怪>灵液黏黏怪>猩红史莱姆>猩红斧>蹦蹦兽>血爬虫>脸怪=猩红喀迈拉。

恶心浮游怪(ID:182)概率1/5，要求困难模式，刷怪面不在rockLayer之上，flag4为false。灵液黏黏怪(ID:268)概率1/2，要求困难模式，刷怪面不在rockLayer之上。猩红史莱姆(ID:183/-24/-25)概率1/3，要求困难模式；3个ID的概率比为4:2:3。猩红斧(ID:179)概率1/40，要求困难模式，刷怪面不在rockLayer之上，flag4为false。蹦蹦兽(ID:174)概率1/2（刷怪面不在worldSurface之下）或1（刷怪面在worldSurface之下），要求困难模式。血爬虫(ID:239)概率3/4（刷怪面有背景墙）或1/8（刷怪面无背景墙）。脸怪(ID:181)和猩红喀迈拉(ID:173/-22/-23)概率各为1/2；猩红喀迈拉的三个ID比例为4:2:3。

\subsection{腐化之地}
要求：刷怪面是黑檀石块、黑檀沙块、紫冰雪块、腐化草皮。如果玩家在腐化之地，那么魔矿也可以做刷怪面。刷怪优先级：

爬藤怪(ID:101)概率1/3，要求困难模式，刷怪面不在rockLayer之上。腐化史莱姆(ID:81)概率2/9，恶翅史莱姆(ID:121)概率1/9，要求困难模式。诅咒锤(ID:83)概率1/40，要求困难模式，刷怪面不在rockLayer之上，flag4为false。腐化者(ID:94)概率1/2（刷怪面不在rockLayer之下）或1（刷怪面在rockLayer之下），要求困难模式。以上所有敌怪均未生成，则生成噬魂怪(ID:6/-11/-12)，三个ID比例为4:2:3。

\subsection{地表综合}
要求：刷怪面不低于worldSurface。刷怪优先级：冰雪巨人>彩虹史莱姆>愤怒雨云怪>火星探测器。

冰雪巨人(ID:243)概率1/20，上限1个；要求苔原环境，困难模式，cloudAlpha大于0。彩虹史莱姆(ID:244)概率1/20，上限1个；要求神圣环境，困难模式，cloudAlpha大于0。愤怒雨云怪(ID:250)概率1/10，上限2个；要求非苔原环境，困难模式，cloudAlpha大于0。火星探测器概率1/400（已打过火星入侵）或1/100（未打过火星入侵），上限1个；要求刷怪面和世界中心横坐标距离大于世界宽度$\times$0.165，困难模式，击败过石巨人。

\subsection{地表白天}
要求：刷怪面不低于worldSurface，在白天。刷怪优先级：小动物>史莱姆王>沙漠>哥布林侦察兵>雨天>史莱姆。

\subsubsection{小动物}
要求：刷怪面到重生点的水平距离小于世界宽度的1/3。刷怪优先级：企鹅=蝴蝶=蝎子>鸟。

企鹅和蓝企鹅概率相等，共计1/15，要求刷怪面是雪块或冰雪块。蝴蝶刷怪要求刷怪面是草皮或神圣草皮，刷怪面不在worldSurface之下，概率同\autoref{app11}。兔兔和松鼠对刷怪面位置没有要求，概率同\autoref{app12}。蝎子刷怪要求刷怪面是沙块，蝎子和黑蝎子概率相等，共计1/15。鸟刷怪分两次判定，有一次成功即可：第一次判定要求刷怪面是草皮或神圣草皮，所有鸟总上限6个，时间在4:30到9:30，进行刷怪概率为1/15；第二次判定要求刷怪面是草皮、神圣草皮或雪块，进行刷怪概率为1/15；各种鸟刷怪比例同\autoref{app13}。

\subsubsection{史莱姆王(ID:50)}
要求：刷怪面到重生点水平距离大于世界宽度的1/3，刷怪面是草皮。概率1/300，上限1个。生成位置重新选择，不一定在刷怪面上。

\subsubsection{沙漠}
要求：刷怪面是沙块，不是水中刷怪。刷怪优先级：蚁狮>沙史莱姆=秃鹰。

蚁狮概率1/5，要求通过沙块局部聚簇检查。沙史莱姆(ID:537)概率1/3，秃鹰概率2/3。

\subsubsection{哥布林侦察兵}
要求：刷怪面到重生点水平距离大于世界宽度的1/3。概率1/5（未击败哥布林入侵，敲过暗影珠或猩红之心）或1/15（其他情况）。

\subsubsection{雨天}
要求：在下雨。飞鱼(ID:224)概率1/3，雨伞史莱姆(ID:225)概率1/3。

\subsubsection{史莱姆}
刷怪优先级：丛林史莱姆=冰雪史莱姆>兔兔史莱姆>礼物史莱姆>绿史莱姆>紫史莱姆>蓝史莱姆。

刷怪面是丛林草皮，生成丛林史莱姆(ID:-10)。刷怪面是雪块或冰雪块，生成冰雪史莱姆(ID:147)。兔兔史莱姆(ID:302)概率2/3，要求万圣节。礼物史莱姆(ID:333/334/335/336)概率2/3，要求圣诞节；4个ID等概率生成。绿史莱姆(ID:-3)概率1/3，要求刷怪面到重生点的水平距离小于200格，普通模式。紫史莱姆(ID:-7)概率1/10，要求刷怪面到重生点的水平距离大于400格（专家模式没有这个要求）。以上所有史莱姆均未生成，生成蓝史莱姆(ID:1)。

\subsection{地表夜晚}
要求：刷怪面不低于worldSurface，在晚上。刷怪优先级：萤火虫>乌鸦>眼球怪

萤火虫生成规则同\autoref{app14}。乌鸦(ID:301)概率1/10，要求万圣节。

\subsubsection{眼球怪}
新月概率为7/12，其他时间为1/6。

游荡眼球怪(ID:133)概率1/3，要求困难模式。猫头鹰眼(ID:317)和UFO眼(ID:318)概率各1/4，要求万圣节。以上均未生成，生成恶魔眼(ID:2/-43/190/-38/191/-39/192/-40/193/-41/194/-42)。这所有ID对应的恶魔眼变种见\autoref{tab5452}。六种主变种的刷怪比例为5:1:1:1:1:1，原型和变种的刷怪比例为2:1。

\begin{table}[!h]
    \centering
    \begin{tabular}{c|cccccc}
         &恶魔眼&白内障眼&瞌睡眼&胀大眼&绿眼&紫眼\\\hline
         原型&2&190&191&192&193&194\\
         变种&-43&-38&-39&-40&-41&-42
    \end{tabular}
    \caption{所有恶魔眼变种的ID}
    \label{tab5452}
\end{table}

\section{特殊判定}
\subsection{沙块的局部聚簇检查}
沙块的局部聚簇检查用于检查某一个图格及其下方是否有足够大的一片沙块区域。如果有，检查通过。

\subsection{Boss与事件检查}
Boss与事件检查用于检查是否有正在进行的Boss与事件。如果没有，那么检查通过。Boss也包括\hyperref[app10]{实际上的Boss}。该内容对应源码中的NPC.AnyDanger()
